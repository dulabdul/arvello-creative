---
// src/components/section/Portfolio.astro
import { Button } from '@/components/ui/button';
import { sanityClient, urlFor } from '@/lib/sanity';
import ProjectCarousel, { type ProjectSlideData } from '../ui/projectCarousel';

// --- Props Definition ---
export interface Props {
  lang: 'id' | 'en';
}
const { lang } = Astro.props;

// --- Data Fetching (Parallel) ---
let sectionData = null;
let rawProjects = [];

try {
  // Hanya butuh SATU fetch sekarang!
  sectionData = await sanityClient.fetch(`*[_type == "portfolioSection"][0]`);
  // Ambil array projects yang ada di dalam sectionData
  rawProjects = sectionData?.projects || [];
} catch (error) {
  console.error('Sanity Portfolio Fetch Error:', error);
}

// --- Data Processing & Localization ---

// 1. Localize Static Text
const headline =
  sectionData?.headline?.[lang] ||
  (lang === 'id' ? 'Lihat Hasil Karya Kami' : 'Check our Work');
const subheadline = sectionData?.subheadline?.[lang] || '';
const seeMoreText =
  sectionData?.seeMoreText?.[lang] ||
  (lang === 'id' ? 'Lihat Semua Proyek' : 'See More Projects');
const projectsLink = sectionData?.projectsPageLink || '/projects';

// 2. Process Project Data untuk dikirim ke React
const processedProjects: ProjectSlideData[] = rawProjects
  .map((project: any) => ({
    id: project._id,
    // Generate URL gambar dengan lebar yang cukup untuk retina display
    imageUrl: project.image
      ? urlFor(project.image).width(1200).height(750).fit('crop').url()
      : '',
    imageAlt: project.image?.alt || project.title || 'Project Screenshot',
    projectUrl: project.projectUrl || null,
  }))
  .filter((p) => p.imageUrl); // Hapus item yang tidak punya gambar
---

<section
  id='portfolio'
  class='py-20 md:py-32 bg-slate-50 overflow-hidden relative'>
  {/* Background decoration (abstract shapes mirip referensi) */}
  <div
    class='absolute top-0 inset-x-0 h-64 bg-gradient-to-b from-white to-slate-50 pointer-events-none'
    aria-hidden='true'>
  </div>
  <div
    class='absolute top-20 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-blue-200/20 rounded-full blur-3xl pointer-events-none'
    aria-hidden='true'>
  </div>

  <div class='container mx-auto px-4 max-w-7xl relative z-10'>
    {/* 1. Header Section (Static Text) */}
    <div class='text-center max-w-3xl mx-auto mb-12 md:mb-20'>
      <h2
        class='text-4xl md:text-5xl font-extrabold text-slate-900 leading-tight tracking-tight mb-6'>
        {headline}
      </h2>
      {
        subheadline && (
          <p class='text-lg md:text-xl text-slate-600 leading-relaxed text-balance whitespace-pre-line'>
            {subheadline}
          </p>
        )
      }
    </div>

    {/* 2. The Carousel (React Island) */}
    {
      /* client:visible adalah strategi loading terbaik di sini. 
        React dan data carousel hanya akan di-load ketika user 
        men-scroll mendekati section ini. 
    */
    }
    {
      processedProjects.length > 0 ? (
        <ProjectCarousel
          client:visible
          projects={processedProjects}
        />
      ) : (
        // Fallback jika belum ada proyek di CMS
        <div class='text-center p-12 border-2 border-dashed border-slate-300 rounded-[2rem] text-slate-500'>
          {lang === 'id'
            ? 'Belum ada proyek yang ditampilkan.'
            : 'No projects listed yet.'}
        </div>
      )
    }

    {/* 3. Footer Section ("See More" Button) */}
    <div class='text-center mt-12 md:mt-16'>
      <a href={projectsLink}>
        <Button
          size='lg'
          className='rounded-full px-8 font-semibold bg-blue-600 hover:bg-blue-700'>
          {seeMoreText}
        </Button>
      </a>
    </div>
  </div>
</section>
