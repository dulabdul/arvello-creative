---
// src/pages/en/blog/[slug].astro
import BaseLayout from '@/layouts/BaseLayout.astro';
import { sanityClient, urlFor } from '@/lib/sanity';
import { PortableText } from 'astro-portabletext';
import { getReadingTime, generateToC } from '@/lib/blog-helpers';

// 1. MENDAPATKAN SEMUA SLUG UNTUK SSG
export async function getStaticPaths() {
  const posts = await sanityClient.fetch(
    `*[_type == "post" && defined(slug.en.current)]`,
  );
  return posts.map((post: any) => ({
    params: { slug: post.slug.en.current },
  }));
}

const { slug } = Astro.params;
const lang = 'en';

// 2. FETCH DATA ARTIKEL & REKOMENDASI CERDAS DALAM 1 QUERY
const query = `
  *[_type == "post" && slug.en.current == $slug][0] {
    ...,
    author->,
    category->,
    "relatedPosts": *[
      _type == "post" && 
      category._ref == ^.category._ref && 
      _id != ^._id
    ] | order(publishedAt desc)[0...3] {
      title, slug, mainImage, publishedAt, excerpt, category->
    }
  }
`;

const post = await sanityClient.fetch(query, { slug });

if (!post) return Astro.redirect('/404');

// --- PENGOLAHAN DATA ---
const contentBlocks = post.body?.[lang] || [];
const title = post.title?.[lang] || 'Untitled';
const categoryName = post.category?.title?.[lang] || 'General';
const authorName = post.author?.name || 'Editorial Team';
const heroImage = post.mainImage
  ? urlFor(post.mainImage).width(1600).height(900).url()
  : null;

const publishDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});

// Ekstrak Meta Otomatis
const readingTime = getReadingTime(contentBlocks);
const toc = generateToC(contentBlocks);
---

<BaseLayout
  lang={lang}
  title={`${title} | Blog`}
  description={post.excerpt?.[lang]}>
  <article class='pt-24 md:pt-32 pb-20 bg-slate-50 min-h-screen'>
    <div class='container mx-auto px-4 max-w-7xl'>
      {/* --- 1. HERO SECTION (Sesuai Referensi, Text di dalam Image) --- */}

      {
        heroImage ? (
          <div class='relative w-full aspect-[4/3] md:aspect-[21/9] rounded-[2rem] md:rounded-[3rem] overflow-hidden mb-12 md:mb-20 shadow-xl border border-slate-200'>
            <img
              src={heroImage}
              alt={title}
              class='w-full h-full object-cover'
            />
            {/* Overlay Gradient Hitam di bawah untuk teks */}
            <div class='absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent' />

            <div class='absolute bottom-0 left-0 w-full p-8 md:p-12 lg:p-16'>
              <h1 class='text-3xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight max-w-4xl capitalize'>
                {title}
              </h1>
            </div>
          </div>
        ) : (
          <h1 class='text-4xl md:text-6xl font-extrabold text-slate-900 leading-tight mb-12 capitalize text-center'>
            {title}
          </h1>
        )
      }

      {/* --- 2. LAYOUT KONTEN KIRI & KANAN --- */}
      <div
        class='grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-16 items-start relative'>
        {/* KOLOM KIRI: MAIN ARTICLE CONTENT */}
        <div class='lg:col-span-8 w-full'>
          <div
            class='prose prose-lg prose-slate prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-blue-600 hover:prose-a:text-blue-500 prose-img:rounded-[2rem] prose-img:border prose-img:border-slate-100 prose-img:shadow-md max-w-none'
            id='article-content'>
            {
              contentBlocks.length > 0 ? (
                <PortableText value={contentBlocks} />
              ) : (
                <p>Content not available in this language.</p>
              )
            }
          </div>
        </div>

        {/* KOLOM KANAN: STICKY SIDEBAR */}
        <aside class='lg:col-span-4 sticky top-32 flex flex-col gap-6 w-full'>
          {/* Box 1: Blog Meta Data */}
          <div
            class='bg-white rounded-[2rem] p-8 border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)]'>
            <div class='grid grid-cols-2 gap-y-8 gap-x-4 mb-8'>
              <div>
                <p class='text-sm font-medium text-slate-400 mb-1'>
                  Publication Date
                </p>
                <p class='font-bold text-slate-900'>{publishDate}</p>
              </div>

              <div>
                <p class='text-sm font-medium text-slate-400 mb-1'>Category</p>
                <p class='font-bold text-slate-900'>{categoryName}</p>
              </div>

              <div>
                <p class='text-sm font-medium text-slate-400 mb-1'>
                  Reading Time
                </p>
                <p class='font-bold text-slate-900'>{readingTime} Min</p>
              </div>

              <div>
                <p class='text-sm font-medium text-slate-400 mb-1'>
                  Author Name
                </p>
                <p class='font-bold text-slate-900'>{authorName}</p>
              </div>
            </div>

            {/* Share Button (Copy Link) */}
            <button
              id='copy-link-btn'
              class='w-full flex items-center justify-center gap-2 bg-slate-50 hover:bg-slate-900 text-slate-700 hover:text-white border border-slate-200 hover:border-slate-900 transition-all duration-300 rounded-xl py-4 font-bold'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                width='18'
                height='18'
                viewBox='0 0 24 24'
                fill='none'
                stroke='currentColor'
                stroke-width='2'
                stroke-linecap='round'
                stroke-linejoin='round'
                ><path
                  d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'
                ></path><path
                  d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'
                ></path></svg
              >
              <span id='copy-link-text'>Share Article (Copy Link)</span>
            </button>
          </div>

          {/* Box 2: Table of Contents */}
          {
            toc.length > 0 && (
              <div class='bg-slate-100/50 rounded-[2rem] p-8 border border-slate-200/60'>
                <h3 class='text-sm font-bold text-slate-900 uppercase tracking-wider mb-6 flex items-center gap-2'>
                  <svg
                    xmlns='http://www.w3.org/2000/svg'
                    width='18'
                    height='18'
                    viewBox='0 0 24 24'
                    fill='none'
                    stroke='currentColor'
                    stroke-width='2'
                    stroke-linecap='round'
                    stroke-linejoin='round'
                    class='text-blue-600'>
                    <>
                      <line
                        x1='8'
                        y1='6'
                        x2='21'
                        y2='6'
                      />
                      <line
                        x1='8'
                        y1='12'
                        x2='21'
                        y2='12'
                      />
                      <line
                        x1='8'
                        y1='18'
                        x2='21'
                        y2='18'
                      />
                      <line
                        x1='3'
                        y1='6'
                        x2='3.01'
                        y2='6'
                      />
                      <line
                        x1='3'
                        y1='12'
                        x2='3.01'
                        y2='12'
                      />
                      <line
                        x1='3'
                        y1='18'
                        x2='3.01'
                        y2='18'
                      />
                    </>
                  </svg>
                  Table of Contents
                </h3>
                <ul class='space-y-4'>
                  {toc.map((item) => (
                    <li
                      class={`${item.style === 'h3' ? 'ml-4 text-sm' : 'text-base font-medium'} text-slate-500 hover:text-blue-600 transition-colors`}>
                      <a
                        href={`#${item.id}`}
                        class='flex items-start gap-2 toc-link'>
                        <span class='text-blue-400 mt-1 text-[10px]'>‚óè</span>
                        {item.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
        </aside>
      </div>
    </div>
  </article>

  {/* --- REKOMENDASI CERDAS --- */}
  {
    post.relatedPosts && post.relatedPosts.length > 0 && (
      <section class='py-20 bg-white border-t border-slate-100'>
        <div class='container mx-auto px-4 max-w-7xl'>
          <h2 class='text-3xl md:text-4xl font-bold text-slate-900 mb-12 text-center'>
            Related Articles
          </h2>

          <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8'>
            {post.relatedPosts.map((related: any) => {
              const relTitle = related.title?.[lang] || 'Untitled';
              const relImage = related.mainImage
                ? urlFor(related.mainImage).width(600).height(400).url()
                : '';
              const relatedSlug = related.slug?.en?.current;

              if (!relatedSlug) return null;

              return (
                <a
                  href={`/en/blog/${relatedSlug}`}
                  class='group flex flex-col bg-slate-50 rounded-[2rem] border border-slate-100 overflow-hidden shadow-[0_4px_20px_rgb(0,0,0,0.03)] hover:shadow-xl hover:-translate-y-1 transition-all duration-300'>
                  <div class='relative aspect-video bg-slate-200 overflow-hidden m-2 rounded-[1.5rem]'>
                    <img
                      src={relImage}
                      alt={relTitle}
                      class='w-full h-full object-cover group-hover:scale-105 transition-transform duration-500'
                    />
                    <div class='absolute top-3 left-3 bg-white/80 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-blue-600 uppercase'>
                      {related.category?.title?.[lang]}
                    </div>
                  </div>
                  <div class='p-6 flex-grow flex flex-col justify-center'>
                    <h3 class='text-xl font-bold text-slate-900 group-hover:text-blue-600 transition-colors line-clamp-2 capitalize'>
                      {relTitle}
                    </h3>
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>

{/* SCRIPT CLIENT-SIDE UNTUK FUNGSI INTERAKTIF */}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1. FUNGSI COPY LINK SHARE BUTTON
    const copyBtn = document.getElementById('copy-link-btn');
    const copyText = document.getElementById('copy-link-text');

    if (copyBtn && copyText) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);

          // Ubah state visual tombol
          const originalText = copyText.innerText;
          copyText.innerText = 'Link Copied!';
          copyBtn.classList.remove('bg-slate-50', 'text-slate-700');
          copyBtn.classList.add(
            'bg-green-500',
            'text-white',
            'border-green-500',
          );

          // Kembalikan ke state awal setelah 2 detik
          setTimeout(() => {
            copyText.innerText = originalText;
            copyBtn.classList.remove(
              'bg-green-500',
              'text-white',
              'border-green-500',
            );
            copyBtn.classList.add('bg-slate-50', 'text-slate-700');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy link: ', err);
        }
      });
    }

    // 2. FUNGSI FIX TABLE OF CONTENTS (Inject ID ke H2 & H3)
    // Script ini akan membaca semua tag h2 dan h3 di dalam artikel dan memberikannya atribut ID
    // sesuai dengan pola yang ada di fungsi generateToC() kamu, agar anchor link berfungsi 100%
    const articleContainer = document.getElementById('article-content');
    if (articleContainer) {
      const headings = articleContainer.querySelectorAll('h2, h3');
      headings.forEach((heading) => {
        // Logika pembuatan ID sama persis dengan regex di blog-helpers.ts: replace(/\s+/g, '-')
        const text = heading.textContent || '';
        const id = text.trim().toLowerCase().replace(/\s+/g, '-');
        heading.setAttribute('id', id);
      });
    }

    // 3. SMOOTH SCROLLING UNTUK LINK TOC
    document.querySelectorAll('.toc-link').forEach((anchor) => {
      anchor.addEventListener('click', function (e) {
        // Casting event.currentTarget agar TS/JS tidak komplain
        const href = (e.currentTarget as HTMLAnchorElement).getAttribute(
          'href',
        );
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const targetElement = document.querySelector(href);
          if (targetElement) {
            // Offset 100px agar tidak tertutup Navbar fixed saat di-scroll
            const offsetTop =
              targetElement.getBoundingClientRect().top + window.scrollY - 100;
            window.scrollTo({
              top: offsetTop,
              behavior: 'smooth',
            });
          }
        }
      });
    });
  });
</script>
